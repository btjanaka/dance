# t142 eMolecules

This directory contains an example of using DANCE to select molecules with
smirnoff99Frosst `t142` parameters from the eMolecules database. This task is
particularly challenging because calculating the parameters of a single molecule
is computationally intensive. While it may work on small databases, it certainly
does not scale to large databases such as eMolecules.

As such, we have to preprocess eMolecules by calculating the parameters in
advance. Specifically, we:

1. Select a random subset of 1 million molecules from eMolecules (25 million is
   too much for us to calculate).
1. Calculate the parameters of those molecules and save them as tags on the
   molecules in an OEB file.

Now, when DANCE runs, it can read in the molecules from the OEB file, and the
relevance function can look at the parameters stored in the molecule tags. The
rest of the pipeline proceeds as normal. We use a fingerprint function
consisting of the number of atoms in the molecule (with explicit hydrogens), as
well as the WBO of the central bond of the `t142` parameter.

## Instructions

### Main Pipeline

#### Dependencies

**You will need a cluster with slurm installed to run most of the steps below.**

Install the following dependencies:

- dance (see https://dance.readthedocs.io)
- openeye (`conda install -c openeye openeye-toolkits` or
  `pip install -i https://pypi.anaconda.org/openeye/simple openeye-toolkits`)
  - We used version 2019.10.2 in particular
- openforcefield (`conda install -c omnia openforcefield`)
  - We used version 0.6.0 in particular

Download the SMILES version of eMolecules from:
https://www.emolecules.com/info/plus/download-database

Unzip the file and name the SMILES file `emolecules.smi`.

#### Preprocessing

By default, eMolecules contains salts along with the molecules. Run the
following command to generate `emolecules_no_salts.smi`, which has the salts
removed.

```bash
python remove_salts.py emolecules.smi emolecules_no_salts.smi
```

This command should take at most a few minutes to run.

#### Parameter Calculation

Create a local results directory and a tmp directory within it:

```bash
mkdir -p results/tmp
```

Calculate parameters of the molecules by running the following command:

```bash
sbatch --array=0-19 save_molecule_parameters.py
```

The above command will run for approximately 1 day. It will separate the
molecules into 20 separate files named `results/molecules_with_params_{i}.oeb`,
for `i = 0-19`. The parameters will be stored as tags on the molecules. Combine
the result files together into one file with:

```bash
sbatch combine_oebs.py 20
```

This will generate the file `results/combined_molecules_with_parameters.oeb`. It
should take at most an hour to run.

#### Running the Pipeline

Execute the following command to search for `t142` parameters in the molecules.

```bash
sbatch t142_pipeline.py
```

The final dataset should be located in `results/dataset.oeb`. This command
should take several hours. To convert the results to a SMILES file, run:

```
python oeb_to_smiles.py results/dataset.oeb results/dataset.smi
```

#### Visualizing Results

To generate CDF plots showing the distribution of each fingerprint component in
the final dataset, run:

```
python dataset_analysis.py --dataset-oeb results/dataset.oeb
```

These plots will be saved in `results/fingerprint_cdf.png`

#### Cleaning Up

We do not recommend removing slurm output files, as the logging info may contain
useful information. However, if you wish to do so, run:

```bash
rm -f slurm*
```

### Random Selection

In order to benchmark DANCE, we also want to generate a random dataset of
molecules with t142 parameters. Thus, we include `random_selection.py`, which
takes in a molecule file and selects random molecules from it. Run it as
follows to select N molecules from the input file and write them to the output
file.

```bash
python random_selection.py -n [N] --input [FILE] --output [FILE]
```

In particular, we selected 20 molecules from the fingerprinted molecules
generated by DANCE with:

```bash
python random_selection.py -n 20 --input results/fingerprint_output.oeb --output results/t142_random.smi
```

Note that this script may not scale to particularly large files.
